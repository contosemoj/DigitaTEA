<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Digita TEA">
    <title>Digita TEA - Seletor de Fases</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="icon" type="image/png" href="game_icon.png">
    <link rel="manifest" href="manifest.json">
    <script src="sw-register.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            background-color: #f0f9ff;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- TOGGLE SWITCH --- */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #22c55e;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #22c55e;
        }

        /* --- ESTILOS DO JOGO --- */
        .letter-box {
            transition: all 0.2s;
            text-transform: uppercase;
            cursor: default;
        }

        .correct {
            background-color: #86efac !important;
            border-color: #22c55e !important;
            color: #14532d;
            transform: scale(1.05);
        }

        .incorrect {
            background-color: #fca5a5 !important;
            border-color: #ef4444 !important;
            animation: shake 0.4s ease-in-out;
        }

        .active-box {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
            background-color: #fff;
            z-index: 10;
        }

        .filled-static {
            background-color: #e5e7eb;
            color: #9ca3af;
            border-color: #d1d5db;
        }

        /* Teclado e Bot√µes */

        @media (min-width: 768px) {
            .key {
                height: 75px;
                max-width: 110px;
                font-size: 2.2rem;
            }
        }

        .key {
            flex: 1;
            max-width: 90px;
            height: 60px;
            border-radius: 12px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #9ca3af;
            border-bottom: 4px solid #d1d5db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }

        .key:active,
        .key.active-press {
            transform: translateY(4px);
            border-bottom: 0 !important;
            background-color: #e5e7eb;
        }

        .key-learned {
            background-color: #eff6ff;
            color: #1e40af;
            border-bottom: 4px solid #3b82f6;
        }

        /* Dicas */
        .hint-active {
            background-color: #fef08a !important;
            border-color: #eab308 !important;
            transform: scale(1.05);
            color: #854d0e !important;
            opacity: 1 !important;
        }

        .hint-inactive {
            opacity: 0.3 !important;
            filter: grayscale(100%);
            pointer-events: none;
        }

        /* N√≠veis */
        .level-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .level-card:active {
            transform: scale(0.95);
        }

        .level-locked {
            filter: grayscale(100%);
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Scroll customizado para o grid de fases */
        .level-grid-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .level-grid-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .level-grid-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .level-grid-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Scroll customizado para chat */
        #chatGameContainer::-webkit-scrollbar {
            width: 6px;
        }

        #chatGameContainer::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatGameContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #chatGameContainer::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- CHAT DIALOGUE --- */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .chat-row {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            width: 100%;
        }

        .chat-row-left {
            justify-content: flex-start;
        }

        .chat-row-right {
            justify-content: flex-end;
        }

        .chat-bubble {
            padding: 1.25rem 1.75rem;
            border-radius: 1.75rem;
            font-size: 1.25rem;
            font-weight: bold;
            position: relative;
            animation: bounceIn 0.5s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chat-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .chat-bubble-left {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border: 3px solid #93c5fd;
            color: #1e40af;
            border-bottom-left-radius: 0.25rem;
        }

        .chat-bubble-right {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 3px solid #4ade80;
            color: #166534;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-avatar {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            border: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 1;
        }

        /* Typing indicator animation */
        .typing-indicator {
            display: inline-flex;
            gap: 0.25rem;
            align-items: center;
        }

        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: #93c5fd;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        /* Message sent animation */
        @keyframes messageSent {
            0% {
                transform: scale(0.8) translateY(20px);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .message-sent {
            animation: messageSent 0.6s ease-out;
        }

        /* --- SUBTITLES --- */
        .subtitle-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            pointer-events: none;
            z-index: 50;
        }

        .subtitle-box {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 10px 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .subtitle-word-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .subtitle-emoji {
            font-size: 1.5rem;
            line-height: 1;
            height: 1.5rem;
            margin-bottom: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle-text {
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body class="h-screen h-[100dvh] w-full flex flex-col bg-blue-50 relative">

    <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-[60]"></canvas>

    <!-- TELA DE SETUP / SELE√á√ÉO DE FASES -->
    <div id="screenSetup" class="absolute inset-0 z-[100] bg-white flex flex-col">
        <!-- Cabe√ßalho -->
        <div class="bg-blue-500 p-4 shadow-md z-10 shrink-0 flex flex-wrap justify-between items-center gap-2">
            <div>
                <h1 class="text-3xl font-bold text-white">Digita TEA üöÄ</h1>
                <p id="userGreeting" class="text-blue-100 text-sm">Selecione uma fase</p>
            </div>
            <div class="flex gap-2 items-center flex-wrap">
                <!-- Bot√£o Google Injetado Aqui -->
                <div id="googleLoginBtn"
                    class="bg-white rounded-lg overflow-hidden flex items-center justify-center min-w-[150px] min-h-[40px]">
                </div>

                <!-- Perfil (Escondido por padr√£o) -->
                <div id="userProfile"
                    class="hidden flex items-center gap-2 bg-blue-600 p-1 pr-3 rounded-full border border-blue-400">
                    <img id="userAvatar" src="" class="w-8 h-8 rounded-full border-2 border-white object-cover">
                    <span id="userNameDisplay" class="text-white text-sm font-bold truncate max-w-[100px]">Nome</span>
                    <button onclick="logoutGoogle()" class="text-xs text-red-300 ml-1 font-bold hover:text-red-100 p-1"
                        title="Sair do Google">‚úñ</button>
                </div>

                <!-- Bot√£o de Estat√≠sticas -->
                <button onclick="showStatsModal()"
                    class="text-xs text-white bg-purple-500 border border-purple-400 px-3 py-2 rounded-lg hover:bg-purple-600 font-bold flex items-center gap-1 shadow-sm transition-colors">
                    üìä Stats
                </button>

                <button onclick="resetProgress()"
                    class="text-xs text-blue-200 bg-blue-600 px-3 py-2 border border-blue-400 rounded-lg hover:bg-blue-700 font-bold transition-colors">
                    Limpar
                </button>
            </div>
        </div>

        <!-- Conte√∫do Principal com Scroll -->
        <div class="flex-1 overflow-y-auto level-grid-scroll p-4 pb-24 bg-blue-50">

            <!-- Painel de Configura√ß√µes -->
            <div class="bg-white rounded-xl p-4 mb-6 border border-blue-100 mx-auto max-w-2xl">
                <div class="flex flex-wrap gap-4 justify-center md:justify-between items-center">

                    <!-- Dificuldade -->
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-gray-500 mb-1">Dificuldade para passar:</span>
                        <select id="difficultySelect"
                            class="p-2 rounded-lg border border-blue-200 text-gray-600 font-bold bg-white text-sm">
                            <option value="0">Muito F√°cil (Passa Sempre)</option>
                            <option value="50">F√°cil (> 50%)</option>
                            <option value="70" selected> M√©dio (> 70%)</option>
                            <option value="80">Dif√≠cil (> 80%)</option>
                        </select>
                    </div>

                    <!-- Modo de Ajuda -->
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-gray-500 mb-1">Modo de Ajuda:</span>
                        <select id="helpModeSelect"
                            class="p-2 rounded-lg border border-green-200 text-green-700 font-bold bg-white text-sm">
                            <option value="NORMAL">Normal (Sem Dicas)</option>
                            <option value="HINTS">Dicas Visuais</option>
                            <option value="LEARN" selected>Modo Aprender (Progressivo)</option>
                        </select>
                    </div>
                </div>

                <!-- Configura√ß√£o de V√≠deos de Pr√™mio -->
                <div class="mt-6 border-t-2 border-blue-50 pt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-bold text-gray-500">V√≠deos de Pr√™mio (YouTube):</span>
                        <span id="videoCountLabel" class="text-xs font-bold text-blue-400">0/10</span>
                    </div>
                    <div id="rewardVideosList" class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                        <!-- Lista de v√≠deos injetada aqui -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="newVideoInput" placeholder="Cole o link ou ID do YouTube aqui..."
                            class="flex-1 p-2 rounded-xl border-2 border-blue-100 text-sm focus:border-blue-300 outline-none transition-colors">
                        <button onclick="addRewardVideo()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-sm transition-colors shadow-sm">
                            Adicionar
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">Dica: Um v√≠deo ser√° escolhido aleatoriamente ao completar
                        uma fase.</p>
                </div>
            </div>

            <!-- Grid de Fases -->
            <div id="levelsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                <!-- As fases ser√£o geradas aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- TELA DE APRESENTA√á√ÉO / TRANSI√á√ÉO -->
    <div id="screenPresentation" class="hidden absolute inset-0 z-[50] bg-white flex flex-col items-center p-4">
        <div class="w-full h-16 flex items-center justify-between border-b border-gray-100 shrink-0 px-4">
            <button onclick="goToMenu()"
                class="text-gray-400 hover:text-gray-600 font-bold text-sm bg-gray-100 px-3 py-1 rounded-lg">
                ‚¨Ö MENU
            </button>
            <span id="presentationTitle" class="text-gray-400 font-bold uppercase tracking-widest">APRENDENDO</span>
            <div class="w-16"></div> <!-- Espa√ßador para centralizar t√≠tulo -->
        </div>
        <div class="flex-1 flex flex-col items-center justify-center w-full max-w-3xl text-center overflow-y-auto"
            id="presentationContent"></div>
        <div class="w-full shrink-0 py-6 flex flex-col gap-3 items-center bg-white border-t border-gray-100">
            <button id="btnPresentationNext" onclick="advanceLinearFlow()"
                class="w-full max-w-md bg-green-500 text-white text-3xl font-bold py-5 px-8 rounded-2xl shadow-[0_6px_0_rgb(21,128,61)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest animate__animated animate__pulse animate__infinite">
                PR√ìXIMO ‚ûî
            </button>
        </div>
    </div>

    <!-- TELA DO JOGO -->
    <div id="screenGame" class="hidden flex-col w-full h-full z-[10]">
        <div
            class="w-full h-14 bg-blue-50 border-b border-blue-100 flex items-center justify-between px-4 shrink-0 shadow-sm z-30">
            <button onclick="goToMenu()"
                class="text-blue-400 font-bold hover:bg-blue-100 p-2 rounded-lg transition-colors">
                ‚¨Ö Voltar
            </button>
            <div class="text-sm text-blue-400 font-bold uppercase tracking-wider hidden md:block" id="gameLevelDisplay">
                N√≠vel 0</div>
            <div class="flex gap-3">
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-blue-200 shadow-sm">
                    <span class="text-lg">‚≠ê</span><span id="scoreDisplay" class="text-blue-600 font-bold">0</span>
                </div>
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-green-200 shadow-sm">
                    <span class="text-lg">üéØ</span><span id="accuracyDisplay"
                        class="text-green-600 font-bold">100%</span>
                </div>
            </div>
        </div>

        <div class="w-full h-2 bg-gray-200 shrink-0">
            <div id="progressBar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center p-2 relative overflow-hidden bg-white/50 w-full">

            <div id="gameInstruction" class="text-xl font-bold text-blue-400 mt-2 mb-2 text-center shrink-0">Escreva:
            </div>

            <!-- MODO QUIZ (NOVO) -->
            <div id="quizContainer" class="hidden w-full flex-col items-center justify-center flex-1">
                <div class="mb-6 bg-white p-4 rounded-3xl border-4 border-purple-200 shadow-sm">
                    <div id="quizImage" class="h-40 flex items-center justify-center text-8xl"></div>
                </div>
                <div id="quizOptions" class="grid grid-cols-2 gap-4 w-full max-w-2xl px-4">
                    <!-- Options injected here -->
                </div>
            </div>

            <!-- MODO DIALOGUE (NOVO) -->
            <div id="chatGameContainer"
                class="hidden w-full flex-col flex-1 overflow-y-auto p-4 mb-4 gap-4 max-w-2xl mx-auto custom-scroll">
                <!-- Chat messages injected here -->
            </div>

            <!-- MODO NORMAL (PADR√ÉO) -->
            <div id="standardGameContainer" class="w-full flex-1 flex flex-col items-center justify-center min-h-0">
                <div class="flex-1 w-full flex items-center justify-center min-h-0 mb-4 px-4">
                    <div class="image-monitor w-full flex-1 max-w-lg max-h-64 bg-white border-4 border-blue-400 rounded-3xl relative cursor-pointer hover:scale-[1.01] transition-transform shadow-lg flex items-center justify-center"
                        onclick="playCurrentAudio()">
                        <div id="gameImageContainer" class="w-full h-full flex items-center justify-center p-4"></div>
                        <div class="absolute bottom-2 right-2 bg-blue-100 p-2 rounded-full opacity-60">üîä</div>
                    </div>
                </div>
            </div>

            <!-- √ÅREA DE INPUT COMPARTILHADA (S√çLABAS E DI√ÅLOGO) -->
            <div id="inputContainer" class="flex flex-wrap justify-center gap-2 mb-4 shrink-0 transition-all"></div>

            <div id="successOverlay"
                class="hidden absolute inset-0 z-40 bg-white/95 flex flex-col items-center justify-start pt-4 animate__animated animate__fadeIn">
                <div id="feedbackMessage"
                    class="text-5xl md:text-6xl font-black text-green-500 mb-8 drop-shadow-sm animate__animated animate__pulse">
                    MUITO BEM! üéâ</div>
                <div id="syllableHighlight"
                    class="hidden text-[12rem] md:text-[18rem] font-black text-purple-600 mb-8 animate__animated"></div>
                <button id="btnNextItem" onclick="nextGameItem()"
                    class="bg-green-500 hover:bg-green-400 text-white text-3xl font-bold py-6 px-12 rounded-3xl shadow-[0_10px_0_rgb(21,128,61)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest animate__animated animate__pulse animate__infinite">
                    PR√ìXIMO ‚ûî
                </button>
            </div>
        </div>

        <footer id="keyboardArea" class="shrink-0 bg-white border-t border-gray-200 pb-4 pt-2 px-1 shadow-lg z-20">
            <div id="keyboardContainer" class="max-w-4xl mx-auto flex flex-col gap-2 md:gap-4"></div>
        </footer>
    </div>

    <!-- TELA DE V√çDEO (PR√äMIO) -->
    <div id="screenVideo"
        class="hidden absolute inset-0 z-[200] bg-black/95 flex flex-col items-center justify-center p-4 animate__animated animate__fadeIn">
        <div
            class="w-full max-w-5xl aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl relative border-4 border-white/20">
            <div id="videoFrame" class="w-full h-full"></div>
            <div id="videoSubtitleContainer" class="subtitle-container hidden">
                <div id="videoSubtitleBox" class="subtitle-box"></div>
            </div>
        </div>
        <button onclick="closeVideoReward()"
            class="mt-8 bg-red-500 hover:bg-red-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg transition-transform active:scale-95 hover:scale-105 uppercase tracking-widest flex items-center gap-3 animate__animated animate__bounceIn delay-1000">
            <span>‚ùå</span> FECHAR E CONTINUAR
        </button>
    </div>

    <!-- TELA DE ESTAT√çSTICAS -->
    <div id="screenStats" class="hidden absolute inset-0 z-[150] bg-blue-50 flex flex-col items-center">
        <div class="w-full bg-blue-500 p-4 shadow-md z-10 shrink-0 flex items-center justify-between">
            <button onclick="closeStatsModal()"
                class="text-sm font-bold text-blue-500 bg-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                ‚¨Ö VOLTAR
            </button>
            <h1 class="text-2xl font-bold text-white uppercase tracking-wider">Estat√≠sticas do Aluno</h1>
            <div class="w-20"></div>
        </div>
        <div class="flex-1 w-full max-w-4xl p-6 flex flex-col items-center overflow-y-auto">
            <div
                class="w-full bg-white rounded-2xl p-6 mb-6 shadow-sm border border-blue-100 flex justify-around items-center">
                <div class="text-center">
                    <p class="text-sm text-gray-500 font-bold uppercase mb-1">M√©dia de Acertos</p>
                    <p id="statsAvgAccuracy" class="text-4xl font-black text-green-500">0%</p>
                </div>
                <div class="h-12 w-px bg-gray-200"></div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 font-bold uppercase mb-1">Fases Jogadas</p>
                    <p id="statsTotalPlayed" class="text-4xl font-black text-purple-500">0</p>
                </div>
            </div>
            <div class="w-full flex-1 min-h-[400px] bg-white rounded-2xl p-4 shadow-sm border border-blue-100 relative">
                <h2 class="text-lg font-bold text-gray-600 mb-4 text-center">Evolu√ß√£o nas √öltimas Tentativas</h2>
                <div class="relative w-full h-[300px]">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- √Åudios -->
    <audio id="sndCorrect" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="sndWordWin" src="https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg"></audio>
    <audio id="sndLevelWin" src="audios/fimfase.mp3"></audio>
    <audio id="sndLose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_whistle.ogg"></audio>

    <script>
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        const pathAudio = "audios/";
        const pathImg = "img/";

        // --- DADOS DAS FASES ---
        let levels = {};
        let currentLevelData = []; // Only load current level data
        let videoRewards = []; // External video rewards data
        let youtubePlayer = null;
        let subtitleSyncInterval = null;
        let currentVideoData = null;

        // --- VARI√ÅVEIS DE ESTADO ---
        let gameMode = 'SYLLABLES'; // 'SYLLABLES', 'DIALOGUE', 'QUIZ'
        let configHints = false;
        let isProgressiveMode = false;
        let isSecondPass = false;
        let difficultyThreshold = 80;
        let currentLevel = 0;
        let score = 0;
        let flowState = 'SETUP';
        let gameQueue = [];
        let currentItem = null;
        let currentBoxIndex = 0;
        let presentationQueue = [];
        let presentationIndex = 0;
        let targetIndices = [];
        let learnedLetters = new Set();
        let phaseCorrectAttempts = 0;
        let phaseTotalAttempts = 0;
        let missedQuizItems = []; // Track missed quiz items for retry

        // --- DADOS DO USU√ÅRIO ---
        let currentUserEmail = 'guest';

        // --- SISTEMA DE PERSIST√äNCIA (SALVAR) ---
        function getSavedProgress() {
            const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
            const unlocked = localStorage.getItem(prefix + 'digita_max_level') || 0;
            const records = JSON.parse(localStorage.getItem(prefix + 'digita_records') || '{}');
            return { maxLevel: parseInt(unlocked), records: records };
        }

        function saveProgress(level, accuracy) {
            const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';

            // Salvar hist√≥rico para gr√°ficos
            const historyList = JSON.parse(localStorage.getItem(prefix + 'digita_history') || '[]');
            historyList.push({ date: new Date().toISOString(), level: level, accuracy: Math.round(accuracy) });
            localStorage.setItem(prefix + 'digita_history', JSON.stringify(historyList));

            // Prevent saving if in "Dicas Visuais" mode (Only Normal and Learn modes save records)
            if (configHints && !isProgressiveMode) {
                console.log("Progress (record) not saved: Visual Hints mode active.");
                const progress = getSavedProgress();
                if (level + 1 > progress.maxLevel) {
                    progress.maxLevel = level + 1;
                    localStorage.setItem(prefix + 'digita_max_level', progress.maxLevel);
                }
                return;
            }

            const progress = getSavedProgress();
            if (level + 1 > progress.maxLevel) {
                progress.maxLevel = level + 1;
                localStorage.setItem(prefix + 'digita_max_level', progress.maxLevel);
            }
            const currentRecord = progress.records[level] || 0;
            if (accuracy > currentRecord) {
                progress.records[level] = Math.round(accuracy);
                localStorage.setItem(prefix + 'digita_records', JSON.stringify(progress.records));
            }
        }

        function resetProgress() {
            if (confirm('Tem certeza que deseja apagar todo o progresso do perfil atual?')) {
                const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
                localStorage.removeItem(prefix + 'digita_max_level');
                localStorage.removeItem(prefix + 'digita_records');
                localStorage.removeItem(prefix + 'digita_history');
                location.reload();
            }
        }

        // --- INICIALIZA√á√ÉO E MENU ---
        window.onload = async function () {
            try {
                // Initialize Google Login
                google.accounts.id.initialize({
                    client_id: "847290940381-807s3g28d575qoh05r1ksah159oqbso8.apps.googleusercontent.com", // Placeholder (usar um real qdo em prod) ou n√£o precisa em localhost as vezes
                    callback: handleCredentialResponse,
                    auto_select: true
                });
                google.accounts.id.renderButton(
                    document.getElementById("googleLoginBtn"),
                    { theme: "outline", size: "small", type: "standard", shape: "pill" }
                );

                const response = await fetch('data/levels.json');
                if (!response.ok) throw new Error("Erro ao carregar levels.json");
                levels = await response.json();

                // Carregar v√≠deos de pr√™mio do arquivo externo
                try {
                    const vidResponse = await fetch('data/video_rewards.json');
                    if (vidResponse.ok) videoRewards = await vidResponse.json();
                } catch (vidErr) {
                    console.warn("Could not load external video rewards:", vidErr);
                }

                renderLevelGrid();

                // Renderizar config de v√≠deos (movemos para c√° para garantir carga)
                renderRewardVideosConfig();
            } catch (e) {
                console.error("Critical Error loading levels:", e);
                document.getElementById('levelsGrid').innerHTML = `<div class="col-span-full text-center text-red-500 font-bold p-10">Erro ao carregar fases. Tente recarregar a p√°gina.<br>${e.message}</div>`;
            }
        };

        function goToMenu() {
            showScreen('SETUP');
            renderLevelGrid();
        }

        function renderLevelGrid() {
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            const progress = getSavedProgress();
            const totalLevels = Object.keys(levels).length;

            for (let i = 0; i < totalLevels; i++) {
                const isLocked = i > progress.maxLevel;
                const record = progress.records[i] !== undefined ? progress.records[i] + '%' : null;
                const levelData = levels[i];

                const card = document.createElement('div');
                card.className = `level-card bg-white border-b-4 rounded-xl p-4 flex flex-col items-center justify-between min-h-[140px] cursor-pointer select-none ${isLocked ? 'level-locked bg-gray-100 border-gray-300' : levelData.color.replace('bg-', 'hover:bg-opacity-80 border-')}`;

                let titleDisplay = levelData.title;
                if (titleDisplay.startsWith("Letra ")) titleDisplay = titleDisplay.replace('Letra ', '');

                if (isLocked) {
                    card.innerHTML = `
                        <div class="text-gray-400 text-4xl mb-2">üîí</div>
                        <div class="text-gray-400 font-bold text-lg">Fase ${i}</div>
                        <div class="text-xs text-gray-400 font-bold uppercase mt-2">Bloqueada</div>
                    `;
                } else {
                    card.onclick = () => startGameFromMenu(i);
                    const recordHtml = record ? `<div class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full font-bold shadow-sm">üèÜ ${record}</div>` : `<div class="text-gray-300 text-xs font-bold">--%</div>`;

                    card.innerHTML = `
                        <div class="w-full flex justify-between items-start">
                            <span class="text-gray-400 text-xs font-bold">Fase ${i}</span>
                            ${recordHtml}
                        </div>
                        <div class="text-3xl md:text-4xl font-black mb-1 mt-2 text-center break-words leading-tight">${titleDisplay}</div>
                        <div class="mt-auto w-full bg-black/5 h-1 rounded-full overflow-hidden">
                            <div class="h-full bg-current opacity-30" style="width: ${progress.records[i] || 0}%"></div>
                        </div>
                    `;
                    card.classList.add(levelData.color.split(' ')[1]);
                }
                grid.appendChild(card);
            }
        }

        function startGameFromMenu(lvl) {
            const helpMode = document.getElementById('helpModeSelect').value;

            isProgressiveMode = false;

            // Show loading state if needed, but fetch is fast enough usually.
            document.body.style.cursor = 'wait';

            initLevel(lvl).finally(() => {
                document.body.style.cursor = 'default';
            });
        }

        function showScreen(screenName) {
            document.getElementById('screenSetup').classList.add('hidden');
            document.getElementById('screenPresentation').classList.add('hidden');
            document.getElementById('screenGame').classList.add('hidden');
            document.getElementById('screenVideo').classList.add('hidden');
            document.getElementById('screenStats').classList.add('hidden');
            document.getElementById('screenStats').classList.remove('flex');

            if (screenName === 'SETUP') document.getElementById('screenSetup').classList.remove('hidden');
            else if (screenName === 'PRESENTATION') document.getElementById('screenPresentation').classList.remove('hidden');
            else if (screenName === 'GAME') {
                document.getElementById('screenGame').classList.remove('hidden');
                document.getElementById('screenGame').classList.add('flex');
            }
            else if (screenName === 'VIDEO') document.getElementById('screenVideo').classList.remove('hidden');
            else if (screenName === 'STATS') {
                document.getElementById('screenStats').classList.remove('hidden');
                document.getElementById('screenStats').classList.add('flex');
            }

            // Optimization: Stop confetti if leaving game screen (although confetti overlays everything, good practice)
            if (screenName !== 'GAME') {
                if (window.stopConfetti) window.stopConfetti();
            }
        }

        // --- ESTAT√çSTICAS ---
        let performanceChartInstance = null;

        function showStatsModal() {
            showScreen('STATS');

            const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
            const historyList = JSON.parse(localStorage.getItem(prefix + 'digita_history') || '[]');

            // Calculate stats
            if (historyList.length > 0) {
                const totalAcc = historyList.reduce((sum, item) => sum + item.accuracy, 0);
                document.getElementById('statsAvgAccuracy').innerText = Math.round(totalAcc / historyList.length) + '%';
                document.getElementById('statsTotalPlayed').innerText = historyList.length;
            } else {
                document.getElementById('statsAvgAccuracy').innerText = '0%';
                document.getElementById('statsTotalPlayed').innerText = '0';
            }

            // Draw Chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            // Limit to last 20 plays for better visualization
            const recentHistory = historyList.slice(-20);
            const labels = recentHistory.map((h, i) => `J${i + 1} (Fase ${h.level})`);
            const data = recentHistory.map(h => h.accuracy);

            performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precis√£o (%)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 3,
                        pointBackgroundColor: '#2563eb',
                        pointHoverBackgroundColor: '#1e40af',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function (value) { return value + "%" }, font: { weight: 'bold' } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) { return ` Precis√£o: ${context.parsed.y}%`; }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function closeStatsModal() {
            showScreen('SETUP');
        }

        // --- GOOGLE LOGIN ---
        function handleCredentialResponse(response) {
            try {
                const data = jwtDecode(response.credential);
                currentUserEmail = data.email;

                document.getElementById('googleLoginBtn').classList.add('hidden');
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = data.given_name || data.name.split(' ')[0];
                document.getElementById('userAvatar').src = data.picture;
                document.getElementById('userGreeting').innerText = `Bem-vindo, ${data.given_name || data.name.split(' ')[0]}`;

                renderLevelGrid(); // Repinta tela com dados do usu√°rio
            } catch (e) {
                console.error("Erro ao decodificar token Google", e);
            }
        }

        function logoutGoogle() {
            currentUserEmail = 'guest';

            document.getElementById('googleLoginBtn').classList.remove('hidden');
            document.getElementById('userProfile').classList.add('hidden');
            document.getElementById('userGreeting').innerText = 'Selecione uma fase';

            renderLevelGrid(); // Repinta tela com dados de visitante

            // Limpa possivel sele√ß√£o auto
            google.accounts.id.disableAutoSelect();
        }

        function jwtDecode(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        async function initLevel(lvl) {
            try {
                // Clear previous level data to free memory
                currentLevelData = [];
                if (window.gc) window.gc(); // Hint to browser if available (usually not in standard JS but good intent)

                // Fetch new level data
                const response = await fetch(`data/level_${lvl}.json`);
                if (!response.ok) throw new Error(`Fase ${lvl} n√£o encontrada.`);
                currentLevelData = await response.json(); // Data loaded from level_X.json
            } catch (e) {
                console.error("Error loading level:", e);
                alert("Erro ao carregar a fase. Verifique sua conex√£o.");
                goToMenu();
            }

            // Cleanup Audio before level start
            if (window.voicePlayer) {
                window.voicePlayer.pause();
                window.voicePlayer.src = "";
            }

            // Continue with setup
            // Reset configuration from user selection (persists across levels)
            const helpModeSelect = document.getElementById('helpModeSelect');
            const helpMode = helpModeSelect ? helpModeSelect.value.trim() : 'NORMAL';

            // Strict boolean logic
            isProgressiveMode = (helpMode === 'LEARN');
            configHints = (helpMode === 'HINTS' || helpMode === 'LEARN');

            // Restore Difficulty Setting
            const diffSelect = document.getElementById('difficultySelect');
            difficultyThreshold = diffSelect ? parseInt(diffSelect.value) : 80;

            console.log(`initLevel ${lvl}: SelectedMode=${helpMode}, Hints=${configHints}, Progressive=${isProgressiveMode}, Diff=${difficultyThreshold}`);

            currentLevel = lvl;
            isSecondPass = false;

            // Validation already done via fetch catch block somewhat, but let's check items
            if (!currentLevelData || !currentLevelData.items) {
                alert("Dados da fase corrompidos.");
                goToMenu();
                return;
            }

            learnedLetters = new Set();
            for (let i = 0; i <= currentLevel; i++) {
                if (levels[i] && levels[i].unlock) levels[i].unlock.forEach(l => learnedLetters.add(l));
            }

            // DETERMINE GAME MODE FROM LEVEL TYPE
            const lvlData = levels[currentLevel];
            const typeLower = (lvlData.type || '').toLowerCase();

            if (typeLower === 'quiz') {
                gameMode = 'QUIZ';
                // Quiz forces specific settings overrides
                configHints = false;
                isProgressiveMode = false;
            } else if (typeLower === 'dialogue' || typeLower === 'context') {
                gameMode = 'DIALOGUE';
            } else {
                gameMode = 'SYLLABLES';
            }

            // BRANCH BY MODE
            if (gameMode === 'QUIZ') {
                startQuizGame();
            } else if (gameMode === 'DIALOGUE') {
                startDialogueGame();
            } else {
                startIntroSyllables();
            }
        }

        function startIntroSyllables() {
            flowState = 'INTRO';
            const data = levels[currentLevel];

            document.getElementById('presentationTitle').textContent = "INTRODU√á√ÉO";
            resetPresentationButton();

            // L√≥gica para MODO CONTEXTO (Di√°logo) - Used in Syllable Mode only for specific levels
            if (data.type === 'context') {
                const introTitle = data.introTitle || data.title;
                const items = data.syllables || [];

                let html = `
                    <div class="chat-container">
                        <!-- Pergunta do Professor -->
                        <div class="chat-row chat-row-left animate__animated animate__fadeInLeft">
                            <div class="chat-avatar">ü¶â</div>
                            <div class="chat-bubble chat-bubble-left">
                                ${introTitle}
                            </div>
                        </div>
                `;

                // Respostas (Aluno)
                // Vamos agrupar as respostas num √∫nico bal√£o ou v√°rios?
                // V√°rios bal√µes ficam mais din√¢micos.
                items.forEach((item, idx) => {
                    const delay = (idx + 1) * 600; // Delay progressivo
                    html += `
                        <div class="chat-row chat-row-right animate__animated animate__fadeInRight" style="animation-delay: ${delay}ms">
                            <div class="chat-bubble chat-bubble-right">
                                ${item}
                            </div>
                            <div class="chat-avatar">üë§</div>
                        </div>
                    `;
                });

                html += `</div>`;
                document.getElementById('presentationContent').innerHTML = html;
                showScreen('PRESENTATION');
            }
            // L√≥gica PADR√ÉO (S√≠labas) -> AGORA INTERATIVA
            else {
                startIntroSyllableGame();
            }
        }

        function startIntroSyllableGame() {
            flowState = 'INTRO_SYLLABLES_GAME';
            const data = levels[currentLevel];

            // Configurar para modo de aprendizado for√ßado
            configHints = true;
            isProgressiveMode = false; // Dicas sempre vis√≠veis

            // Preparar fila com as s√≠labas
            gameQueue = [...data.syllables].map(s => ({ word: s, emoji: "", image: "" }));
            // Inverter para usar pop()
            gameQueue.reverse();

            document.getElementById('gameLevelDisplay').textContent = `Aprendendo: ${data.title}`;

            // Hide presentation button to prevent accidental clicks during transition
            const presentationBtn = document.getElementById('btnPresentationNext');
            if (presentationBtn) presentationBtn.style.display = 'none';

            showScreen('GAME');
            setupGameUI();
            renderKeyboard();
            nextGameItem();
        }

        function startPresentationWords() {
            flowState = 'PRES';

            // Restore presentation button visibility (may have been hidden during intro syllables)
            const presentationBtn = document.getElementById('btnPresentationNext');
            if (presentationBtn) {
                presentationBtn.style.display = '';
                presentationBtn.classList.remove('hidden');
            }

            presentationQueue = [...currentLevelData.items];
            presentationIndex = 0;
            showNextPresentationWord();
        }

        function showNextPresentationWord() {
            if (presentationIndex >= presentationQueue.length) {
                // Modified: Now ALL levels skip the syllable game and go straight to words
                startWordGame();
                return;
            }
            const item = presentationQueue[presentationIndex];
            let mediaHtml = item.image ?
                `<img src="${pathImg + item.image}" class="max-h-48 mx-auto drop-shadow-md animate__animated animate__jackInTheBox" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> <span style="display:none" class="text-9xl animate__animated animate__jackInTheBox">${item.emoji}</span>` :
                `<span class="text-9xl animate__animated animate__jackInTheBox">${item.emoji}</span>`;
            let html = `<div class="bg-white border-4 border-purple-200 rounded-3xl p-8 mb-6 shadow-sm w-full max-w-lg mx-auto">${mediaHtml}</div><div class="text-7xl font-bold text-gray-600 tracking-widest uppercase mb-4 animate__animated animate__fadeInUp">${item.word}</div>`;
            document.getElementById('presentationTitle').textContent = "PALAVRAS NOVAS";
            document.getElementById('presentationContent').innerHTML = html;
            resetPresentationButton(); // Ensure button is configured correctly
            showScreen('PRESENTATION');
            playAudio(item.word);
        }

        function advanceLinearFlow() {
            if (flowState === 'INTRO') startPresentationWords();
            else if (flowState === 'PRES') { presentationIndex++; showNextPresentationWord(); }
            else if (flowState === 'TRANSITION_TO_SYL') {
                startWordGame();
            }
            else if (flowState === 'TRANSITION_TO_WORD') startWordGame();
            else if (flowState === 'END_PHASE') initLevel(currentLevel + 1);
            else if (flowState === 'RETRY') {
                if (gameMode === 'QUIZ') startQuizGame();
                else if (gameMode === 'DIALOGUE') startDialogueGame();
                else startWordGame();
            }
        }

        function prepareGameQueue() {
            // Updated to use currentLevelItems instead of database global
            let allItems = [...currentLevelData.items];
            let greetingItem = null;

            // Remove "OI" from the shuffle pool
            allItems = allItems.filter(item => {
                if (item.word === "OI") {
                    greetingItem = item;
                    return false;
                }
                return true;
            });

            // Shuffle or fixed order
            if (gameMode === 'DIALOGUE') {
                // For dialogue, follow fixed order (reverse because we pop)
                gameQueue = allItems.reverse();
            } else {
                // Shuffle the rest
                gameQueue = allItems.sort(() => Math.random() - 0.5);
            }

            // Add "OI" back at the END of the array (so it is popped first)
            // Ensure this only happens in relevant modes if needed, but if the item exists, it's likely intended.
            if (greetingItem) {
                gameQueue.push(greetingItem);
            }

            if (isProgressiveMode && !isSecondPass) configHints = true;
            if (!isSecondPass) { phaseTotalAttempts = 0; phaseCorrectAttempts = 0; }
            updateStatsUI();
        }

        function startSyllableGame() {
            flowState = 'GAME_SYL';
            const letter = levels[currentLevel].title.replace("Letra ", "");
            document.getElementById('gameLevelDisplay').textContent = `Fase ${currentLevel} - ${letter} (S√≠labas)`;
            prepareGameQueue();
            showScreen('GAME');
            setupGameUI();
            renderKeyboard();
            nextGameItem();
        }

        function startWordGame() {
            flowState = 'GAME_WORD';
            const lvlData = levels[currentLevel];

            // Restore user's help mode configuration (may have been overridden by intro syllable game)
            const helpModeSelect = document.getElementById('helpModeSelect');
            const helpMode = helpModeSelect ? helpModeSelect.value.trim() : 'NORMAL';
            isProgressiveMode = (helpMode === 'LEARN');
            configHints = (helpMode === 'HINTS' || helpMode === 'LEARN');

            let titleText = "";
            if (lvlData.type === 'context') {
                titleText = `Fase ${currentLevel} - ${lvlData.title}`;
            } else {
                const letter = lvlData.title.replace("Letra ", "");
                titleText = `Fase ${currentLevel} - ${letter} (Palavras)`;
            }

            document.getElementById('gameLevelDisplay').textContent = titleText;
            prepareGameQueue();
            showScreen('GAME');
            setupGameUI();
            renderKeyboard();
            nextGameItem();
        }

        function updateStatsUI() {
            document.getElementById('scoreDisplay').textContent = score;
            let acc = 100;
            if (phaseTotalAttempts > 0) acc = Math.round((phaseCorrectAttempts / phaseTotalAttempts) * 100);
            document.getElementById('accuracyDisplay').textContent = acc + "%";

            const accEl = document.getElementById('accuracyDisplay');
            if (acc < difficultyThreshold && difficultyThreshold > 0) {
                accEl.classList.remove('text-green-600'); accEl.classList.add('text-orange-500');
            } else {
                accEl.classList.remove('text-orange-500'); accEl.classList.add('text-green-600');
            }
        }

        function nextGameItem() {
            if (gameQueue.length === 0) {
                if (gameMode === 'QUIZ' && missedQuizItems.length > 0) {
                    // Refill queue with missed items
                    gameQueue = [...missedQuizItems].sort(() => Math.random() - 0.5);
                    missedQuizItems = []; // Clear missed list for the next pass
                    currentItem = gameQueue.pop(); // Proceed immediately
                }
                else if (flowState === 'INTRO_SYLLABLES_GAME') {
                    // Acabou as s√≠labas da introdu√ß√£o -> vai para palavras
                    startPresentationWords();
                    return;
                }
                else {
                    // Logic for other modes or Quiz finished
                    if (isProgressiveMode && !isSecondPass) {
                        isProgressiveMode = false; // Disable progressive for second pass
                        isSecondPass = true;
                        configHints = false;
                        showIntermission();
                        return;
                    }
                    checkEndPhase();
                    isSecondPass = false;
                    return;
                }
            } else {
                currentItem = gameQueue.pop();
            }

            // Progress bar calculation
            // In INTRO_SYLLABLES_GAME, use syllables count; otherwise use items count
            const total = flowState === 'INTRO_SYLLABLES_GAME'
                ? levels[currentLevel].syllables.length
                : currentLevelData.items.length;
            const progress = ((total - gameQueue.length) / total) * 100;
            document.getElementById('progressBar').style.width = `${Math.min(100, Math.max(0, progress))}%`;

            const levelLetter = levels[currentLevel].title.replace("Letra ", "").trim();

            // Auto-configure OI greeting if not explicitly set
            if (currentItem.word === "OI" && (gameMode === 'DIALOGUE' || flowState === 'GAME_DIALOGUE')) {
                if (!currentItem.question) currentItem.question = "OI üëã";
            }

            if (currentItem.question) {
                document.getElementById('gameInstruction').textContent = currentItem.question;
                targetIndices = Array.from({ length: currentItem.word.length }, (_, i) => i);
            } else if (flowState === 'GAME_SYL') {
                document.getElementById('gameInstruction').textContent = "Complete a s√≠laba:";
                targetIndices = findSyllableIndices(currentItem.word, levelLetter);
                if (targetIndices.length === 0) targetIndices = Array.from({ length: currentItem.word.length }, (_, i) => i);
            } else if (gameMode === 'DIALOGUE') {
                // Better instruction for dialogue mode
                if (currentItem.word === "OI") {
                    document.getElementById('gameInstruction').textContent = "Responda ao professor:";
                } else {
                    document.getElementById('gameInstruction').textContent = "Digite sua resposta:";
                }
                targetIndices = Array.from({ length: currentItem.word.length }, (_, i) => i);
            } else if (flowState === 'INTRO_SYLLABLES_GAME') {
                document.getElementById('gameInstruction').textContent = "Vamos aprender! Digite:";
                targetIndices = Array.from({ length: currentItem.word.length }, (_, i) => i);
            } else {
                document.getElementById('gameInstruction').textContent = "Escreva a palavra:";
                targetIndices = Array.from({ length: currentItem.word.length }, (_, i) => i);
            }
            renderGameRound();
        }

        function showIntermission() {
            const html = `
                <div class="bg-blue-100 border-4 border-blue-300 rounded-full p-8 mb-6 shadow-sm inline-block animate__animated animate__bounceIn">
                    <span class="text-8xl">üôà</span>
                </div>
                <h2 class="text-4xl font-bold text-blue-600 mb-4 animate__animated animate__fadeIn">Agora sem ajuda!</h2>
                <p class="text-xl text-gray-500 max-w-md mx-auto mb-8">Voc√™ consegue fazer de novo sem as cores?</p>
                <button onclick="startSecondPass()" class="bg-blue-500 hover:bg-blue-400 text-white text-2xl font-bold py-4 px-10 rounded-2xl shadow-[0_6px_0_rgb(37,99,235)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest">
                    VAMOS L√Å!
                </button>
            `;
            document.getElementById('presentationTitle').textContent = "DESAFIO";
            document.getElementById('presentationContent').innerHTML = html;
            resetPresentationButton(); // Should not matter as the button is inline? Wait, showIntermission uses presentationContent innerHTML which CONTANS a button.
            showScreen('PRESENTATION');
        }

        function startSecondPass() {
            if (gameMode === 'DIALOGUE') {
                gameQueue = [...currentLevelData.items].reverse();
            } else {
                gameQueue = [...currentLevelData.items].sort(() => Math.random() - 0.5);
            }
            phaseTotalAttempts = 0;
            phaseCorrectAttempts = 0;
            updateStatsUI();
            showScreen('GAME');
            renderKeyboard();
            nextGameItem();
        }

        function renderGameRound() {
            document.getElementById('successOverlay').classList.add('hidden');

            if (gameMode === 'QUIZ') {
                renderQuiz();
                return;
            } else if (gameMode === 'DIALOGUE') {
                renderDialogue();
                return;
            }

            const imgContainer = document.getElementById('gameImageContainer');
            if (currentItem.image) {
                imgContainer.innerHTML = `<img src="${pathImg + currentItem.image}" class="max-h-48 max-w-full object-contain animate__animated animate__fadeIn" onerror="this.outerHTML='<span class=\\'text-8xl\\'>${currentItem.emoji}</span>'">`;
            } else {
                imgContainer.innerHTML = `<span class="text-8xl animate__animated animate__fadeIn">${currentItem.emoji}</span>`;
            }

            if (currentItem.questionAudio) {
                playFile(currentItem.questionAudio);
            } else {
                playAudio(currentItem.word);
            }

            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            currentBoxIndex = targetIndices[0];

            for (let i = 0; i < currentItem.word.length; i++) {
                const div = document.createElement('div');
                div.className = 'letter-box w-12 h-14 md:w-16 md:h-20 border-4 rounded-xl flex items-center justify-center text-3xl md:text-5xl font-bold shadow-sm bg-white m-1';
                div.id = `box-${i}`;
                if (!targetIndices.includes(i)) {
                    div.classList.add('filled-static');
                    div.textContent = currentItem.word[i];
                } else {
                    div.classList.add('text-gray-700', 'border-gray-300');
                }
                container.appendChild(div);
            }
            updateActiveBox();

            // Wait for word audio to finish before giving the hint (Visual + Audio)
            // This prevents the letter sound from overlapping with the word pronunciation.
            if (configHints) {
                // Remove any previous listener to be safe
                voicePlayer.onended = null;

                // Set one-time listener
                voicePlayer.onended = () => {
                    updateKeyboardHints();
                    voicePlayer.onended = null; // Clean up
                };

                // Fallback: If for some reason audio fails/network issue, show hint after 3s max
                setTimeout(() => {
                    if (voicePlayer.onended) {
                        if (voicePlayer.paused) {
                            updateKeyboardHints();
                            voicePlayer.onended = null;
                        }
                    }
                }, 3000);
            } else {
                setTimeout(updateKeyboardHints, 50);
            }
        }

        function handleInput(char) {
            if (gameMode === 'QUIZ') return;
            if (!document.getElementById('successOverlay').classList.contains('hidden')) return;
            if (currentBoxIndex >= currentItem.word.length) return;

            while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) currentBoxIndex++;
            if (currentBoxIndex >= currentItem.word.length) return;

            phaseTotalAttempts++;
            const targetChar = currentItem.word[currentBoxIndex];
            const normInput = char.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const normTarget = targetChar.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (normInput === normTarget) {
                phaseCorrectAttempts++;
                const box = document.getElementById(`box-${currentBoxIndex}`);
                if (box) {
                    box.textContent = targetChar;
                    box.classList.remove('active-box');
                    box.classList.add('correct');
                }

                document.getElementById('sndCorrect').currentTime = 0;
                document.getElementById('sndCorrect').play();

                currentBoxIndex++;
                while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) currentBoxIndex++;

                if (currentBoxIndex >= currentItem.word.length) {
                    roundWon();
                } else {
                    updateActiveBox();
                    updateKeyboardHints();
                }
            } else {
                const box = document.getElementById(`box-${currentBoxIndex}`);
                if (box) {
                    box.classList.add('incorrect');
                    setTimeout(() => box.classList.remove('incorrect'), 400);
                }
                // Play audio of the correct letter that should have been pressed
                playAudio(targetChar);
            }
            updateStatsUI();
        }

        function roundWon() {
            const overlay = document.getElementById('successOverlay');
            overlay.classList.remove('hidden');

            // Logic for Dialogue Mode
            if (gameMode === 'DIALOGUE') {
                const chat = document.getElementById('chatGameContainer');
                const userDiv = document.createElement('div');
                userDiv.className = "chat-row chat-row-right message-sent";
                const displayContent = (currentItem.emoji ? currentItem.emoji + " " : "") + currentItem.word;
                userDiv.innerHTML = `
                    <div class="chat-bubble chat-bubble-right">
                        ${displayContent}
                    </div>
                    <div class="chat-avatar">üë§</div>
                `;
                chat.appendChild(userDiv);
                chat.scrollTop = chat.scrollHeight;

                // Play the audio of the response word
                setTimeout(() => {
                    playAudio(currentItem.word);
                }, 200);

                // Add professor's reaction (postText)
            }

            // Play appropriate sound effect
            if (levels[currentLevel].title === "Sons Animais" && gameMode !== 'QUIZ') {
                playAudio(currentItem.word);
            } else if (gameMode !== 'DIALOGUE') {
                // Only play word win sound if not in dialogue mode (dialogue plays word audio)
                document.getElementById('sndWordWin').currentTime = 0;
                document.getElementById('sndWordWin').play();
            }

            score += 10;
            updateStatsUI();
            fireConfetti();
            document.querySelectorAll('.key').forEach(k => k.classList.remove('hint-active', 'hint-inactive'));

            if (flowState === 'INTRO_SYLLABLES_GAME') {
                // Tocar √°udio da s√≠laba
                playAudio(currentItem.word);

                // Feedback visual customizado: S√≠laba GIANT
                const feedbackMsg = document.getElementById('feedbackMessage');
                const nextBtn = document.getElementById('btnNextItem');
                const highlight = document.getElementById('syllableHighlight');

                feedbackMsg.classList.add('hidden');
                nextBtn.classList.add('hidden');

                highlight.textContent = currentItem.word;
                highlight.classList.remove('hidden', 'animate__jackInTheBox');
                void highlight.offsetWidth; // trigger reflow
                highlight.classList.add('animate__jackInTheBox');

                // Anima√ß√£o de sucesso r√°pida e pr√≥ximo item
                const boxes = document.querySelectorAll('.correct');
                boxes.forEach(b => b.classList.add('animate__animated', 'animate__pulse'));

                setTimeout(() => {
                    overlay.classList.add('hidden');
                    // Reset overlay for next time
                    feedbackMsg.classList.remove('hidden');
                    nextBtn.classList.remove('hidden');
                    highlight.classList.add('hidden');
                    nextGameItem();
                }, 2000);
                return;
            }
        }

        function checkEndPhase() {
            const acc = phaseTotalAttempts === 0 ? 0 : (phaseCorrectAttempts / phaseTotalAttempts) * 100;
            let title, msg, nextState, buttonText = "PR√ìXIMO ‚ûî";

            if (acc < difficultyThreshold) {
                document.getElementById('sndLose').play();
                title = "Vamos tentar de novo?";
                msg = `Voc√™ fez ${Math.round(acc)}%. Precisa de ${difficultyThreshold}% para passar.`;
                nextState = 'RETRY';
                buttonText = "TENTAR DE NOVO ‚Ü∫";
                document.getElementById('presentationTitle').textContent = "REVIS√ÉO";
            } else {
                document.getElementById('sndLevelWin').play();
                if (flowState === 'GAME_SYL') {
                    title = "S√≠labas Completas!";
                    msg = "Agora vamos escrever as palavras inteiras.";
                    nextState = 'TRANSITION_TO_WORD';
                } else {
                    title = "N√≠vel Conclu√≠do!";
                    const nextLvl = levels[currentLevel + 1];
                    msg = nextLvl ? `Voc√™ desbloqueou: ${nextLvl.title}` : "Voc√™ terminou o jogo!";
                    nextState = 'END_PHASE';
                    saveProgress(currentLevel, acc);
                }
                document.getElementById('presentationTitle').textContent = "PARAB√âNS";
            }

            flowState = nextState;
            const isFail = nextState === 'RETRY';
            const colorClass = isFail ? 'text-orange-500' : 'text-green-500';
            const borderClass = isFail ? 'border-orange-200' : 'border-green-200';
            const emoji = isFail ? 'üí™' : '‚≠ê';

            if (isFail) {
                const actionBtn = document.getElementById('btnPresentationNext');
                actionBtn.textContent = "TENTAR DE NOVO ‚Ü∫";
                actionBtn.classList.replace('bg-green-500', 'bg-orange-500');
                actionBtn.classList.replace('shadow-[0_6px_0_rgb(21,128,61)]', 'shadow-[0_6px_0_rgb(249,115,22)]');
            } else {
                const actionBtn = document.getElementById('btnPresentationNext');
                if (nextState === 'END_PHASE') {
                    // Adicionar bot√£o de pr√™mio apenas no final da fase
                    actionBtn.textContent = "üéÅ VER PR√äMIO";
                    actionBtn.onclick = showVideoReward;
                } else {
                    resetPresentationButton();
                }
            }

            let html = `<div class="bg-white border-4 ${borderClass} rounded-full p-10 mb-6 shadow-sm inline-block"><span class="text-8xl">${emoji}</span></div><h2 class="text-4xl font-bold ${colorClass} mb-4">${title}</h2><p class="text-xl text-gray-500 max-w-md mx-auto">${msg}</p>`;
            document.getElementById('presentationContent').innerHTML = html;
            showScreen('PRESENTATION');
        }

        function resetPresentationButton() {
            const btn = document.getElementById('btnPresentationNext');
            if (btn) {
                btn.textContent = "PR√ìXIMO ‚ûî";
                btn.onclick = advanceLinearFlow;
                btn.classList.remove('bg-orange-500', 'shadow-[0_6px_0_rgb(249,115,22)]');
                btn.classList.add('bg-green-500', 'shadow-[0_6px_0_rgb(21,128,61)]');
                btn.classList.remove('hidden'); // Restore visibility
            }
        }


        function renderKeyboard() {
            const layout = ["QWERTYUIOP", "ASDFGHJKL√á", "ZXCVBNM"];
            const container = document.getElementById('keyboardContainer');
            container.innerHTML = '';
            const rows = layout.map(r => r.split('')); // Convert layout to array of arrays

            rows.forEach(r => {
                const rowDiv = document.createElement('div');
                rowDiv.className = "flex justify-center gap-1 md:gap-3 mb-1 md:mb-2";
                r.forEach(char => {
                    const btn = document.createElement('button');
                    btn.textContent = char;
                    btn.id = `key-${char}`;
                    btn.dataset.char = char; // Store char in dataset to avoid closure capture issues

                    let btnClass = "key";
                    if (learnedLetters.has(char)) btnClass += " key-learned";
                    btn.className = btnClass;

                    // Use named function or generic handler to avoid circular closure over 'btn'
                    btn.addEventListener('touchstart', handleKeyboardTouchStart, { passive: false });
                    btn.addEventListener('touchend', handleKeyboardTouchEnd, { passive: false });
                    btn.addEventListener('click', handleKeyboardClick);

                    rowDiv.appendChild(btn);
                });
                container.appendChild(rowDiv);
            });
        }

        // Optimized handlers to prevent memory leaks
        function handleKeyboardTouchStart(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            btn.classList.add('active-press');
            const char = btn.dataset.char;
            if (char) handleInput(char);
        }

        function handleKeyboardTouchEnd(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            btn.classList.remove('active-press');
        }

        function handleKeyboardClick(e) {
            const btn = e.currentTarget;
            const char = btn.dataset.char;
            if (char) handleInput(char);
        }

        function updateKeyboardHints() {
            document.querySelectorAll('.key').forEach(k => k.classList.remove('hint-active', 'hint-inactive'));

            if (!configHints || !currentItem || !document.getElementById('successOverlay').classList.contains('hidden')) return;

            let tempIndex = currentBoxIndex;
            while (tempIndex < currentItem.word.length && !targetIndices.includes(tempIndex)) tempIndex++;

            if (tempIndex < currentItem.word.length) {
                const targetChar = currentItem.word[tempIndex].normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                // In INTRO_SYLLABLES_GAME mode, only highlight the correct key without disabling others
                if (flowState === 'INTRO_SYLLABLES_GAME') {
                    document.querySelectorAll('.key').forEach(k => {
                        const keyChar = k.textContent.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        if (keyChar === targetChar) k.classList.add('hint-active');
                        // Don't add hint-inactive in intro mode - keep all keys enabled
                    });
                } else {
                    // Normal mode: highlight correct key and disable others
                    document.querySelectorAll('.key').forEach(k => {
                        const keyChar = k.textContent.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        if (keyChar === targetChar) k.classList.add('hint-active');
                        else k.classList.add('hint-inactive');
                    });
                }

                // Play spoken hint for the target letter
                playHint(targetChar);
            }
        }

        function updateActiveBox() {
            document.querySelectorAll('.letter-box').forEach(b => b.classList.remove('active-box'));
            let tempIndex = currentBoxIndex;
            while (tempIndex < currentItem.word.length && !targetIndices.includes(tempIndex)) tempIndex++;
            if (tempIndex < currentItem.word.length) {
                const current = document.getElementById(`box-${tempIndex}`);
                if (current) current.classList.add('active-box');
            }
        }

        function findSyllableIndices(word, levelLetter) {
            const indices = [];
            const regex = new RegExp(`(${levelLetter})[AEOIU√Å√â√ç√ì√ö√É√ï√Ç√ä√î]`, 'i');
            const match = word.match(regex);

            if (match && match.index !== undefined) {
                indices.push(match.index, match.index + 1);
            }
            else if (word.toUpperCase().startsWith(levelLetter)) {
                indices.push(0, 1);
                if (word.length < 2) indices.push(0);
            }
            return indices;
        }

        function playAudio(text) {
            const fn = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
            playFile(fn.replace('.mp3', ''));
        }

        const voicePlayer = new Audio();
        const hintPlayer = new Audio(); // Separate player for hints to avoid cutting off main audio

        function playFile(filename) {
            voicePlayer.src = pathAudio + filename + ".mp3";
            voicePlayer.play().catch(() => { });
        }

        function playHint(text) {
            const fn = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
            hintPlayer.src = pathAudio + fn;
            hintPlayer.volume = 0.6; // Slightly lower volume for hints? Or same. Let's keep it standard but separate.
            // Actually, let's keep volume 1.0 but maybe slight delay if it overlaps too much with "Pop" sound?
            // The user wants it "before".
            hintPlayer.play().catch(() => { });
        }

        window.playCurrentAudio = () => {
            if (currentItem) {
                if (currentItem.questionAudio) playFile(currentItem.questionAudio);
                else playAudio(currentItem.word);
            }
        };

        // --- MEMORY AND CRASH PROTECTION ---

        // Helper to force clear DOM elements
        function clearElement(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                while (el.firstChild) {
                    el.removeChild(el.firstChild);
                }
            }
        }

        function safeGameLoopWrapper(fn) {
            return function (...args) {
                try {
                    return fn(...args);
                } catch (e) {
                    console.error("Game Loop Error:", e);
                    // Minimal recovery: Go to menu
                    alert("Ocorreu um erro inesperado. O jogo ser√° reiniciado.");
                    // Set crash flag for next reload to clear SW
                    localStorage.setItem('digita_crash_detected', 'true');
                    location.reload();
                }
            };
        }

        // Apply wrapper to critical entry points?
        // It's hard to wrap everything, but we can wrap the event handlers or the main render.
        // renderGameRound = safeGameLoopWrapper(renderGameRound);
        // nextGameItem = safeGameLoopWrapper(nextGameItem);
        // handleInput = safeGameLoopWrapper(handleInput);

        // Let's implement this wrapping at the end of the script or just modify the functions directly if easier. -> Modifying directly is cleaner logic.


        // --- GAME MODES HELPERS ---

        function setupGameUI() {
            // Reset containers
            document.getElementById('standardGameContainer').classList.add('hidden');
            document.getElementById('chatGameContainer').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('inputContainer').classList.remove('hidden'); // Default show
            document.getElementById('keyboardArea').classList.remove('hidden');

            if (gameMode === 'QUIZ') {
                document.getElementById('quizContainer').classList.remove('hidden');
                document.getElementById('quizContainer').classList.add('flex');
                document.getElementById('inputContainer').classList.add('hidden');
                document.getElementById('keyboardArea').classList.add('hidden');
            } else if (gameMode === 'DIALOGUE') {
                document.getElementById('chatGameContainer').classList.remove('hidden');
                document.getElementById('chatGameContainer').classList.add('flex');

                // Get contextual welcome message based on level
                const lvlData = levels[currentLevel];
                let welcomeMsg = "Vamos come√ßar a conversa!";

                if (lvlData.introTitle) {
                    // Use introTitle to create contextual message
                    const title = lvlData.introTitle;
                    if (title.includes("som")) {
                        welcomeMsg = "Vamos descobrir os sons! üîä";
                    } else if (title.includes("fam√≠lia")) {
                        welcomeMsg = "Vamos falar sobre fam√≠lia! üë®‚Äçüë©‚Äçüëß‚Äçüë¶";
                    } else if (title.includes("Apresenta√ß√£o")) {
                        welcomeMsg = "Vamos nos apresentar! üëã";
                    } else if (title.includes("Transporte")) {
                        welcomeMsg = "Vamos falar sobre transportes! üöó";
                    } else if (title.includes("Escola")) {
                        welcomeMsg = "Vamos falar sobre a escola! üìö";
                    } else if (title.includes("Corpo")) {
                        welcomeMsg = "Vamos aprender sobre o corpo! üôã";
                    } else {
                        welcomeMsg = `${title} üéØ`;
                    }
                }

                // Clear chat and add welcome message with typing indicator
                const chatContainer = document.getElementById('chatGameContainer');
                chatContainer.innerHTML = `
                     <div class="chat-row chat-row-left animate__animated animate__fadeInLeft">
                        <div class="chat-avatar">ü¶â</div>
                        <div class="chat-bubble chat-bubble-left">
                            ${welcomeMsg}
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('standardGameContainer').classList.remove('hidden');
                document.getElementById('standardGameContainer').classList.add('flex'); // Ensure flex
            }
        }

        function startDialogueGame() {
            flowState = 'GAME_DIALOGUE';
            document.getElementById('gameLevelDisplay').textContent = `Fase ${currentLevel} - Di√°logo`;
            prepareGameQueue();
            showScreen('GAME');
            setupGameUI();
            renderKeyboard();
            nextGameItem();
        }

        function startQuizGame() {
            flowState = 'GAME_QUIZ';
            document.getElementById('gameLevelDisplay').textContent = `Fase ${currentLevel} - Quiz`;
            missedQuizItems = []; // Reset missed items
            prepareGameQueue();
            showScreen('GAME');
            setupGameUI();
            nextGameItem();
        }

        function renderQuiz() {
            const container = document.getElementById('quizOptions');
            container.innerHTML = '';

            // Image/Text Display
            const imgDiv = document.getElementById('quizImage');

            // Explicit Image Cleanup
            const oldImg = imgDiv.querySelector('img');
            if (oldImg) {
                oldImg.src = '';
                oldImg.remove();
            }
            imgDiv.innerHTML = ''; // Double ensure

            if (currentItem.image) {
                const newImg = document.createElement('img');
                newImg.src = pathImg + currentItem.image;
                newImg.className = "h-full object-contain";
                imgDiv.appendChild(newImg);
            } else {
                imgDiv.textContent = currentItem.emoji;
            }

            // Distractors
            let options = [currentItem.word];
            // Get random words from other levels
            let tries = 0;
            const allWords = [];
            // Gather all possible words from current level AND maybe we need a fallback for distractors?
            // Since we don't have global 'database', we can only use 'currentLevelItems.items' easily.
            // If we want cross-level distractors, we might need to fetch them or just stick to current level words + generic terms?
            // Or maybe 'levels.json' could contain a small list of common words for distractors?
            // For now, let's use only words from current level. If too few, we might fallback to generic "Op√ß√£o".

            // FIX: database is not available globally. 
            // We can only use items from current level.
            if (currentLevelData && currentLevelData.items) {
                currentLevelData.items.forEach(i => allWords.push(i.word));
            }
            // If we really need more words, we'd need to architecture differently. 
            // Limitation accepted for memory optimization.

            while (options.length < 4 && tries < 100) {
                tries++;
                if (allWords.length > 0) {
                    const randWord = allWords[Math.floor(Math.random() * allWords.length)];
                    if (!options.includes(randWord)) options.push(randWord);
                } else {
                    break; // No words to pull from
                }
            }

            // Fallback if we still don't have 4 options (e.g. nearly empty database)
            while (options.length < 4) {
                options.push("Op√ß√£o " + (options.length + 1));
            }
            options = options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                // Removed hover:bg-blue-50 to prevent sticky hover on touch devices (iPad) selecting wrong answers
                btn.className = "bg-white border-4 border-blue-200 text-blue-600 text-2xl font-bold py-6 rounded-2xl shadow-sm active:scale-95 transition-all";
                btn.textContent = opt;
                btn.dataset.opt = opt;
                btn.dataset.correct = (opt === currentItem.word).toString();

                // Avoid closure capturing 'btn'
                btn.onclick = handleQuizBtnClick;

                container.appendChild(btn);
            });

            if (currentItem.question) document.getElementById('gameInstruction').textContent = currentItem.question;
            else document.getElementById('gameInstruction').textContent = "Qual √© o nome correto?";

            // Play audio immediately for association (before answer)
            setTimeout(() => {
                playCurrentAudio();
            }, 300);
        }



        function handleQuizBtnClick(e) {
            const btn = e.currentTarget;
            const isCorrect = btn.dataset.correct === 'true';
            handleQuizSelection(btn, isCorrect);
        }

        function handleQuizSelection(btn, isCorrect) {
            if (document.getElementById('successOverlay').classList.contains('hidden') === false) return;

            phaseTotalAttempts++;
            if (isCorrect) {
                phaseCorrectAttempts++;
                btn.classList.remove('border-blue-200', 'text-blue-600');
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'animate__animated', 'animate__pulse');
                document.getElementById('sndCorrect').play().catch(() => { });
                setTimeout(roundWon, 500);
            } else {
                // Incorrect logic updated:
                // 1. Mark as incorrect visually
                btn.classList.remove('border-blue-200', 'text-blue-600');
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700', 'animate__animated', 'animate__shakeX');
                document.getElementById('sndLose').play().catch(() => { });

                // 2. Add to missed items
                missedQuizItems.push(currentItem);

                // 3. Disable all buttons to prevent double clicking during delay
                const allBtns = document.getElementById('quizOptions').querySelectorAll('button');
                allBtns.forEach(b => b.disabled = true);

                // 4. Wait 1s then move to next item
                setTimeout(() => {
                    nextGameItem();
                }, 1000);
            }
            updateStatsUI();
        }

        function renderDialogue() {
            const chat = document.getElementById('chatGameContainer');

            // Special handling for OI - it's a greeting, not a Q&A
            if (currentItem.word === "OI") {
                const qDiv = document.createElement('div');
                qDiv.className = "chat-row chat-row-left animate__animated animate__fadeInLeft";

                qDiv.innerHTML = `
                    <div class="chat-avatar">ü¶â</div>
                    <div class="chat-bubble chat-bubble-left flex flex-col">
                        <span>OI! üëã</span>
                    </div>
                `;
                chat.appendChild(qDiv);
                chat.scrollTop = chat.scrollHeight;

                // Play OI audio after a short delay
                setTimeout(() => playAudio("OI"), 300);
            } else {
                // Regular Q&A flow for other words
                const qDiv = document.createElement('div');
                qDiv.className = "chat-row chat-row-left animate__animated animate__fadeInLeft";

                let content = "";
                let media = "";

                if (currentItem.question) {
                    content = currentItem.question;
                } else {
                    content = "Como se escreve?";
                }

                // Enhanced media display with larger emojis
                if (currentItem.image) {
                    media = `<img src="${pathImg + currentItem.image}" class="max-w-[140px] rounded-xl mb-2 block shadow-md border-2 border-blue-100">`;
                } else if (currentItem.emoji) {
                    media = `<span class="text-6xl mb-2 block">${currentItem.emoji}</span>`;
                }

                qDiv.innerHTML = `
                    <div class="chat-avatar">ü¶â</div>
                    <div class="chat-bubble chat-bubble-left flex flex-col">
                        ${media}
                        <span>${content}</span>
                    </div>
                `;
                chat.appendChild(qDiv);
                chat.scrollTop = chat.scrollHeight;

                // Play question audio after a delay
                setTimeout(() => {
                    if (currentItem.questionAudio) {
                        playFile(currentItem.questionAudio);
                    } else {
                        playAudio(currentItem.word);
                    }
                }, 400);
            }

            // Prepare Input
            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            currentBoxIndex = targetIndices[0];

            for (let i = 0; i < currentItem.word.length; i++) {
                const div = document.createElement('div');
                div.className = 'letter-box w-12 h-14 md:w-16 md:h-20 border-4 rounded-xl flex items-center justify-center text-3xl md:text-5xl font-bold shadow-sm bg-white m-1';
                div.id = `box-${i}`;
                if (!targetIndices.includes(i)) {
                    div.classList.add('filled-static');
                    div.textContent = currentItem.word[i];
                } else {
                    div.classList.add('text-gray-700', 'border-gray-300');
                }
                container.appendChild(div);
            }
            updateActiveBox();
            setTimeout(updateKeyboardHints, 50);
        }

        let isAnimatingConfetti = false;
        const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        function fireConfetti() {
            for (let i = 0; i < 30; i++) particles.push({ x: window.innerWidth / 2, y: window.innerHeight / 2, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, size: Math.random() * 8 + 4, color: `hsl(${Math.random() * 360},100%,50%)`, life: 100 });
            if (!isAnimatingConfetti) {
                isAnimatingConfetti = true;
                requestAnimationFrame(animateConfetti);
            }
        }

        function animateConfetti() {
            // Safety check: if canvas is hidden or offscreen, stop animation
            if (document.hidden || !document.getElementById('confetti-canvas')) {
                isAnimatingConfetti = false;
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });

            if (particles.length > 0) {
                requestAnimationFrame(animateConfetti);
            } else {
                isAnimatingConfetti = false;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function stopConfetti() {
            particles = [];
            isAnimatingConfetti = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- SISTEMA DE PR√äMIOS (V√çDEOS) ---
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : url;
        }

        function getRewardVideos() {
            // Unir dados do arquivo JSON com dados do localStorage (prefer√™ncia para o arquivo se houver conflito de ID)
            const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
            const raw = localStorage.getItem(prefix + 'digita_reward_videos') || '[]';
            let storedVideos = JSON.parse(raw).map(v => typeof v === 'string' ? { id: v } : v);

            // Combinar: v√≠deos do JSON + v√≠deos do localStorage que n√£o est√£o no JSON
            const combined = [...videoRewards];
            storedVideos.forEach(sv => {
                if (!combined.find(cv => cv.id === sv.id)) {
                    combined.push(sv);
                }
            });

            // Fallback se n√£o houver nada
            if (combined.length === 0) return [{ id: "ZHKRxjwKnXM" }];

            return combined;
        }

        function renderRewardVideosConfig() {
            const container = document.getElementById('rewardVideosList');
            const videos = getRewardVideos();
            container.innerHTML = '';

            document.getElementById('videoCountLabel').textContent = `${videos.length}/10`;

            if (videos.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 text-xs py-2 italic">Nenhum v√≠deo adicionado. O padr√£o ser√° usado.</div>';
            }

            videos.forEach((vidObj, index) => {
                const vid = vidObj.id;
                const item = document.createElement('div');
                item.className = 'flex flex-col bg-blue-50 p-2 rounded-xl border border-blue-100 group hover:border-blue-200 transition-colors';

                let subtitleInfo = '';
                if (vidObj.subtitle) {
                    subtitleInfo = `<div class="mt-1 text-[10px] text-blue-500 italic truncate ml-19">Legenda: ${vidObj.subtitle}</div>`;
                }

                item.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-16 h-10 bg-gray-200 rounded-lg overflow-hidden shrink-0 shadow-sm border border-blue-100">
                                <img src="https://img.youtube.com/vi/${vid}/mqdefault.jpg" class="w-full h-full object-cover" loading="lazy">
                            </div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">ID do V√≠deo</span>
                                <span class="text-xs font-mono text-blue-700 truncate">${vid}</span>
                            </div>
                        </div>
                        <button onclick="removeRewardVideo(${index})" class="text-gray-400 hover:text-red-500 font-bold px-2 transition-colors">‚úï</button>
                    </div>
                    ${subtitleInfo}
                `;
                container.appendChild(item);
            });
        }

        function addRewardVideo() {
            const input = document.getElementById('newVideoInput');
            let rawValue = input.value.trim();
            if (!rawValue) return;

            // Formato: ID | Legenda | palavra:emoji,palavra:emoji
            const parts = rawValue.split('|').map(p => p.trim());
            const videoId = extractYouTubeId(parts[0]);

            if (videoId.length !== 11) {
                alert("ID do v√≠deo inv√°lido.");
                return;
            }

            let videos = getRewardVideos();
            if (videos.length >= 10) {
                alert("Limite de 10 v√≠deos atingido.");
                return;
            }

            const videoObj = { id: videoId };
            if (parts[1]) videoObj.subtitle = parts[1];
            if (parts[2]) {
                videoObj.mapping = {};
                parts[2].split(',').forEach(pair => {
                    const [word, emoji] = pair.split(':').map(s => s.trim());
                    if (word && emoji) videoObj.mapping[word.toLowerCase()] = emoji;
                });
            }

            if (!videos.find(v => v.id === videoId)) {
                videos.push(videoObj);
                const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
                localStorage.setItem(prefix + 'digita_reward_videos', JSON.stringify(videos));
                renderRewardVideosConfig();
            } else {
                alert("Este v√≠deo j√° foi adicionado.");
            }
            input.value = '';
        }

        function removeRewardVideo(index) {
            let videos = getRewardVideos();
            videos.splice(index, 1);
            const prefix = currentUserEmail !== 'guest' ? currentUserEmail + '_' : '';
            localStorage.setItem(prefix + 'digita_reward_videos', JSON.stringify(videos));
            renderRewardVideosConfig();
        }

        // --- YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            // A API est√° pronta, mas o player ser√° criado sob demanda
        }

        async function showVideoReward() {
            let videos = getRewardVideos();
            if (videos.length === 0) videos = [{ id: "ZHKRxjwKnXM" }];

            const randomIndex = Math.floor(Math.random() * videos.length);
            currentVideoData = videos[randomIndex];
            const videoId = currentVideoData.id;

            // Tentar carregar dados espec√≠ficos do v√≠deo de arquivo JSON
            try {
                const response = await fetch(`data/${videoId}.json`);
                if (response.ok) {
                    const extraData = await response.json();
                    currentVideoData = { ...currentVideoData, ...extraData };
                }
            } catch (e) {
                console.warn(`Could not load specific data for video ${videoId}:`, e);
            }

            // Limpar player anterior se existir
            if (youtubePlayer) {
                try {
                    youtubePlayer.destroy();
                } catch (e) {
                    console.warn("Error destroying previous player:", e);
                }
                youtubePlayer = null;
            }

            // Recriar o elemento videoFrame como div
            const videoContainer = document.querySelector('#screenVideo .aspect-video');
            let oldFrame = document.getElementById('videoFrame');
            if (oldFrame) {
                oldFrame.remove();
            }

            const newFrame = document.createElement('div');
            newFrame.id = 'videoFrame';
            newFrame.className = 'w-full h-full';
            videoContainer.insertBefore(newFrame, videoContainer.firstChild);

            // Mostrar a tela antes de criar o player
            showScreen('VIDEO');

            // Verificar se a API do YouTube est√° dispon√≠vel
            if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                console.warn("YouTube API not loaded, using fallback");
                fallbackToSimpleIframe(videoId);
                return;
            }

            // Criar o player do YouTube
            try {
                youtubePlayer = new YT.Player('videoFrame', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'rel': 0,
                        'modestbranding': 1,
                        'controls': 1,
                        'origin': window.location.origin
                    },
                    events: {
                        'onReady': (event) => {
                            console.log("YouTube player ready");
                            event.target.playVideo();
                        },
                        'onStateChange': onPlayerStateChange,
                        'onError': (e) => {
                            console.error("YouTube Player Error:", e.data);
                            fallbackToSimpleIframe(videoId);
                        }
                    }
                });
            } catch (error) {
                console.error("Error creating YouTube player:", error);
                fallbackToSimpleIframe(videoId);
            }
        }

        function fallbackToSimpleIframe(videoId) {
            const videoContainer = document.querySelector('#screenVideo .aspect-video');
            let frame = document.getElementById('videoFrame');

            // Substituir por um iframe simples se falhar ou API n√£o dispon√≠vel
            const simpleIframe = document.createElement('iframe');
            simpleIframe.id = 'videoFrame';
            simpleIframe.className = 'w-full h-full';
            simpleIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
            simpleIframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            simpleIframe.allowFullscreen = true;

            if (frame) {
                frame.replaceWith(simpleIframe);
            } else {
                videoContainer.prepend(simpleIframe);
            }

            // In simple mode, we don't sync timed subtitles to avoid confusion
            // Only render if it's a static single subtitle
            if (currentVideoData && currentVideoData.subtitle && !currentVideoData.timedSubtitles) {
                renderSubtitle(currentVideoData);
            }
        }



        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                startSubtitleSync();
            } else {
                stopSubtitleSync();
            }
        }

        function startSubtitleSync() {
            stopSubtitleSync();
            subtitleSyncInterval = setInterval(() => {
                if (youtubePlayer && youtubePlayer.getCurrentTime) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    updateTimedSubtitles(currentTime);
                }
            }, 100);
        }

        function stopSubtitleSync() {
            if (subtitleSyncInterval) {
                clearInterval(subtitleSyncInterval);
                subtitleSyncInterval = null;
            }
        }

        function updateTimedSubtitles(seconds) {
            if (!currentVideoData || !currentVideoData.timedSubtitles) {
                // Se for o formato antigo (est√°tico), j√° foi renderizado uma vez
                if (currentVideoData && currentVideoData.subtitle) {
                    renderSubtitle(currentVideoData);
                    currentVideoData.subtitle = null; // Evitar renderizar toda hora
                }
                return;
            }

            const activeSub = currentVideoData.timedSubtitles.find(s => seconds >= s.start && seconds <= s.end);

            if (activeSub) {
                renderSubtitle(activeSub);
            } else {
                document.getElementById('videoSubtitleContainer').classList.add('hidden');
            }
        }

        function renderSubtitle(data) {
            const container = document.getElementById('videoSubtitleContainer');
            const box = document.getElementById('videoSubtitleBox');

            if (!data.text && !data.subtitle) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            box.innerHTML = '';

            const text = data.text || data.subtitle;
            const words = text.split(/\s+/);
            const mapping = data.mapping || {};

            words.forEach(word => {
                const cleanWord = word.replace(/[.,!?;:]/g, "").toLowerCase();
                const emoji = mapping[cleanWord] || "";

                const group = document.createElement('div');
                group.className = 'subtitle-word-group';

                group.innerHTML = `
                    <div class="subtitle-emoji">${emoji}</div>
                    <div class="subtitle-text">${word}</div>
                `;
                box.appendChild(group);
            });
        }

        function closeVideoReward() {
            stopSubtitleSync();
            if (youtubePlayer) {
                try { youtubePlayer.stopVideo(); } catch (e) { }
            }
            document.getElementById('videoSubtitleContainer').classList.add('hidden');
            advanceLinearFlow();
        }

        // Initial load via script tag (avoids CORS issues on local)
        // Initial load via script tag (avoids CORS issues on local)
        // Initialize wrappers for crash protection
        try {
            if (typeof safeGameLoopWrapper === 'function') {
                renderGameRound = safeGameLoopWrapper(renderGameRound);
                nextGameItem = safeGameLoopWrapper(nextGameItem);
                handleInput = safeGameLoopWrapper(handleInput);
            }
        } catch (e) { console.error("Wrapper init failed", e); }

    </script>
    <!-- <script src="gameData.js"></script> REMOVED: Loaded via fetch now -->
</body>

</html>